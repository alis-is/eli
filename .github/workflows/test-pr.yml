name: test-pr

on:
  workflow_dispatch:
  pull_request:
    branches:
      - main
    types: [opened, reopened, synchronize]
    
jobs:
  build-linux-x86_64:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
      with:
        submodules: true
    - name: build-n-cache
      uses: "./.github/template/build-n-cache"
      with:
        toolchain: zig:x86_64-linux-musl
        cache-id: build-linux#${{ github.sha }}
  build-linux-aarch64:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
      with:
        submodules: true
    - name: build-n-cache
      uses: "./.github/template/build-n-cache"
      with:
        toolchain: zig:aarch64-linux-musl
        cache-id: build-linux#${{ github.sha }}
  build-linux-riscv64:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
      with:
        submodules: true
    - name: build-n-cache
      uses: "./.github/template/build-n-cache"
      with:
        toolchain: zig:riscv64-linux-musl
        cache-id: build-linux#${{ github.sha }}

  build-win:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: true
      - name: build-n-cache
        uses: "./.github/template/build-n-cache"
        with:
          toolchain: zig:x86_64-windows-gnu
          cache-id: build-win#${{ github.sha }}

  build-mac:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: true
      - name: build-n-cache
        uses: "./.github/template/build-n-cache"
        with:
          toolchain: zig:x86_64-macos-none
          cache-id: build-mac#${{ github.sha }}

  test-linux:
    runs-on: ubuntu-latest
    needs: build-linux
    steps:
      - uses: actions/checkout@v3
      - uses: "./.github/template/prepare-test"
        with:
          cache-id: build-linux#${{ github.sha }}
      - name: test x86_64
        uses: addnab/docker-run-action@v3
        with:
          image: ghcr.io/alis-is/eli-test:latest
          run: ./tools/test.sh x86_64
          options: -w /root/luabuild -v ${{ github.workspace }}:/root/luabuild -v ${{ github.workspace }}/toolchains:/opt/cross
      - name: test aarch64
        uses: addnab/docker-run-action@v3
        with:
          image: ghcr.io/alis-is/eli-test:latest
          run: ./tools/test.sh aarch64
          options: -w /root/luabuild -v ${{ github.workspace }}:/root/luabuild -v ${{ github.workspace }}/toolchains:/opt/cross
      - name: test riscv64
        uses: addnab/docker-run-action@v3
        with:
          image: ghcr.io/alis-is/eli-test:latest
          run: ./tools/test.sh riscv64
          options: -w /root/luabuild -v ${{ github.workspace }}:/root/luabuild -v ${{ github.workspace }}/toolchains:/opt/cross
          
  test-windows:
    runs-on: windows-latest
    needs: build-win
    steps:
      - uses: actions/checkout@v3
      - uses: "./.github/template/prepare-test"
        with:
          cache-id: build-win#${{ github.sha }}
      - name: test
        shell: pwsh
        run: |
          .\tools\test.ps1 x86_64

  test-macos:
    runs-on: macos-latest
    needs: build-mac
    steps:
      - uses: actions/checkout@v3
      - uses: "./.github/template/prepare-test"
        with:
          cache-id: build-mac#${{ github.sha }}
      - name: test
        shell: pwsh
        run: |
          .\tools\test.sh x86_64